name: Update origin-src for Translation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-origin-src:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - run: git config --global user.name "minchodang"
      - run: git config --global user.email "minsu910725@gmail.com"

      - run: |
          git remote add upstream https://github.com/react-hook-form/documentation.git || true
          git fetch upstream --prune
          git fetch origin --prune

      - run: |
          git checkout -B master origin/master
          git merge --ff-only upstream/master
          git push origin master

      - id: compare
        run: |
          rm -f diff_status.txt
          if [ ! -d origin-src ]; then
            echo CHANGED > diff_status.txt
          else
            mkdir -p tmp-src
            git archive origin/master src | tar -x -C tmp-src
            diff -qr origin-src tmp-src/src || echo CHANGED > diff_status.txt
          fi
          if [ -f diff_status.txt ]; then
            echo "pr_needed=true" >> $GITHUB_ENV
          else
            echo "pr_needed=false" >> $GITHUB_ENV
          fi
        shell: bash

      - if: env.pr_needed == 'true'
        run: |
          if git show-ref --quiet refs/remotes/origin/master-ko; then
            git checkout -B master-ko origin/master-ko
          else
            git checkout -B master-ko
          fi
          rm -rf origin-src
          git archive origin/master src | tar -x
          mv src origin-src
          git add -A origin-src
          if ! git diff --cached --quiet; then
            git commit -m "Update origin-src with latest src from origin/master"
          fi
        shell: bash

      - if: env.pr_needed == 'true'
        id: check-pr
        run: |
          existing=$(gh pr list --json headRefName --jq '.[] | select(.headRefName | startswith("update-origin-src-")) | .headRefName' | head -n1)
          if [ -n "$existing" ]; then
            echo "branch=$existing" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash

      - if: env.pr_needed == 'true' && steps.check-pr.outputs.branch != ''
        run: git push origin master-ko:${{ steps.check-pr.outputs.branch }} --force

      - if: env.pr_needed == 'true' && steps.check-pr.outputs.branch == ''
        run: |
          new_branch=update-origin-src-${{ github.run_id }}
          git checkout -b "$new_branch"
          git push origin "$new_branch"
          gh pr create --title "Update origin-src for translation" \
                       --body "Sync origin-src with the latest src changes from origin/master." \
                       --head "$new_branch" --base master-ko
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
