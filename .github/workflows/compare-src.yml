name: Update src for Translation

on:
  push:
    branches:
      - master

jobs:
  update-src:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch All Branches
        run: git fetch --all

      - name: Compare src Directories
        run: |
          # feature/docs-update 브랜치가 존재하면 해당 브랜치와 origin/master의 src를 비교합니다.
          # 브랜치가 없을 경우 업데이트 필요로 간주합니다.
          if git rev-parse --verify origin/feature/docs-update; then
            git diff --quiet origin/master origin/feature/docs-update -- src || echo "CHANGED"
          else
            echo "CHANGED"
          fi > diff_status.txt
          if grep -q "CHANGED" diff_status.txt; then
            echo "src changes detected."
          else
            echo "No src changes detected."
          fi

      - name: Update feature/docs-update Branch if Needed
        run: |
          if grep -q "CHANGED" diff_status.txt; then
            BRANCH_NAME=update-src-$(date +%Y%m%d%H%M%S)
            # feature/docs-update 브랜치가 존재하면 해당 브랜치에서, 없으면 새로 생성합니다.
            if git rev-parse --verify origin/feature/docs-update; then
              git checkout -B feature/docs-update origin/feature/docs-update
            else
              git checkout -B feature/docs-update
            fi
            # 업데이트를 위한 새 브랜치 생성
            git checkout -b $BRANCH_NAME
            # origin/master의 최신 src 내용을 가져와서 교체합니다.
            git checkout origin/master -- src
            # 실제 변경사항이 있는지 확인 후 커밋합니다.
            if ! git diff --quiet; then
              git add src
              git commit -m "Update src with latest changes from master"
              git push origin $BRANCH_NAME
              # feature/docs-update 브랜치로 PR 생성 (변경사항 비교를 위해)
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/pulls \
                -d '{
                  "title": "Update src with latest changes from master",
                  "body": "This PR updates the src directory in feature/docs-update with the latest changes from master.",
                  "head": "'"${BRANCH_NAME}"'",
                  "base": "feature/docs-update"
                }'
            else
              echo "No changes to commit after updating src."
            fi
          else
            echo "No src changes detected. Skipping update."
          fi
        shell: bash
