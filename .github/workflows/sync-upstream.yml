name: Sync Upstream and Create PR

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # 매일 밤 12시 정각에 실행

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "minchodang"
          git config user.email "minsu910725@gmail.com"

      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/react-hook-form/documentation
          git fetch upstream --prune --tags --depth=1000000
          git fetch origin --prune

      - name: Detect Upstream Changes
        id: detect
        run: |
          if git diff --quiet origin/master..upstream/master -- . ':(exclude).github'; then
            echo "has_changes=false" >> $GITHUB_ENV
          else
            echo "has_changes=true" >> $GITHUB_ENV
          fi
          echo "Detected changes between origin/master and upstream/master"
          echo "master_changed=false" >> $GITHUB_ENV
          echo "master_ko_changed=false" >> $GITHUB_ENV

      - name: Update master branch
        if: env.has_changes == 'true'
        run: |
          set -euo pipefail
          git checkout -B master origin/master
          git merge upstream/master -X theirs --no-edit

          for DIR in .github .vscode; do
            git rm -r --cached "$DIR" || true
            rm -rf "$DIR"
          done

          git checkout --ours .gitignore || true
          git add -A
          if git diff --cached --quiet; then
            echo "master_changed=false" >> $GITHUB_ENV
          else
            git commit -m "Sync with upstream (remove .github & .vscode, keep .gitignore)"
            echo "master_changed=true" >> $GITHUB_ENV
          fi

      - name: Push master branch
        if: env.master_changed == 'true'
        run: |
          git push origin master

      # ===== master-ko 업데이트 =====

      - name: Check Existing master-ko PR
        id: find-ko-pr
        run: |
          RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open")
          REF=$(echo "$RESPONSE" | jq -r '.[] | select(.head.ref | startswith("update-master-ko-")) | .head.ref' | head -n1)
          if [[ -n "$REF" && "$REF" != "null" ]]; then
            echo "existing_ko_pr=true" >> $GITHUB_ENV
            echo "existing_ko_ref=$REF" >> $GITHUB_ENV
          else
            echo "existing_ko_pr=false" >> $GITHUB_ENV
          fi
          echo "Existing master-ko PR branch: $REF"

      - name: Prepare master-ko Update
        run: |
          set -euo pipefail
          git fetch origin master-ko || true
          git checkout -B master-ko origin/master-ko || git checkout -B master-ko

          cp package.json /tmp/pkg_old.json || true
          git checkout upstream/master -- . ":(exclude)src" ":(exclude).github"

          node <<'NODE'
          const fs = require('fs');
          const oldPkg = fs.existsSync('/tmp/pkg_old.json') ? JSON.parse(fs.readFileSync('/tmp/pkg_old.json','utf8')) : {};
          const newPkg = JSON.parse(fs.readFileSync('package.json','utf8'));
          ['dependencies','devDependencies','peerDependencies'].forEach(k=>{
            const upstreamDeps=newPkg[k]||{}, localDeps=oldPkg[k]||{}, merged={...upstreamDeps};
            for(const pkg in localDeps){ if(!(pkg in upstreamDeps)) merged[pkg]=localDeps[pkg]; }
            newPkg[k]=merged;
          });
          const merge=(a,b)=>{for(const k in b){if(b[k]&&typeof b[k]==='object'&&!Array.isArray(b[k]))a[k]=merge(a[k]||{},b[k]);else if(!(k in a))a[k]=b[k];}return a;}
          if(oldPkg.scripts){newPkg.scripts=merge(newPkg.scripts||{},oldPkg.scripts);}
          fs.writeFileSync('package.json',JSON.stringify(newPkg,null,2)+'\n');
          NODE

          for f in .yarnrc.yml README.md; do
            git ls-files --error-unmatch "$f" >/dev/null 2>&1 && git checkout master-ko -- "$f" || true
          done

          rm -f pnpm-lock.yaml
          pnpm install --frozen-lockfile=false || true
          git add -A
          if git diff --cached --quiet; then
            echo "master_ko_changed=false" >> $GITHUB_ENV
          else
            git commit -m "Update master-ko (deep-merge package.json, keep local files)"
            echo "master_ko_changed=true" >> $GITHUB_ENV
          fi

      - name: Push and Create/Update PR for master-ko
        if: env.master_ko_changed == 'true'
        run: |
          if [[ "${{ env.existing_ko_pr }}" == "true" ]]; then
            BRANCH="${{ env.existing_ko_ref }}"
            echo "Updating existing master-ko PR branch: $BRANCH"
            git push origin master-ko:"$BRANCH" --force
          else
            BRANCH="update-master-ko-$(date +%Y%m%d%H%M%S)"
            git checkout -b "$BRANCH"
            git push origin "$BRANCH"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              -d '{
                "title": "Update master-ko (excluding src)",
                "body": "This PR updates the master-ko branch with upstream changes except for the src directory.",
                "head": "'"$BRANCH"'",
                "base": "master-ko"
              }'
          fi
